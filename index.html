<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CryptoLocker - NFT DeFi Platform</title>
  <script src="https://unpkg.com/thirdweb@latest/dist/thirdweb.umd.js"></script>
  <style>
    /* ... (your CSS here, unchanged for brevity) ... */
  </style>
</head>
<body>
  <!-- ... (your HTML layout here, unchanged for brevity) ... -->

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // === CONFIG ===
      const CLIENT_ID = '10f433657d1018e7003e5cd1cb9c61d7';
      const TREASURY_ADDRESS = '0x592B35c8917eD36c39Ef73D0F5e92B0173560b2e';
      const CONTRACT_ADDRESS = '0xe274a85a123f9270d1e0617f7e04632d9d8640d9';
      let CHAIN = "base"; // Default chain

      let sdk, contract, signer;

      // === 1. Wallet Functions ===
      async function connectWallet() {
        sdk = new thirdweb.ThirdwebSDK(CHAIN, { clientId: CLIENT_ID });
        await sdk.wallet.connect("injected");
        signer = await sdk.wallet.getSigner();
        contract = await sdk.getContract(CONTRACT_ADDRESS);
        const address = await sdk.wallet.getAddress();
        document.getElementById('connectBtn').textContent = address.slice(0,6) + '...' + address.slice(-4);
        document.getElementById('connectBtn').disabled = true;
        showNotification("Wallet connected: " + address);
        loadStats();
      }

      // === 2. NFT Minting ===
      async function mintNFT(name, description, contentType, file) {
        if (!contract) {
          showNotification('⚠️ Please connect your wallet first');
          return;
        }
        try {
          // Upload file to IPFS
          let ipfsUrl = "";
          if (file) {
            ipfsUrl = await sdk.storage.upload(file);
          }
          const tokenURI = ipfsUrl || `ipfs://QmExample${Date.now()}`;
          await contract.call("mintNFT", [
            name,
            description,
            contentType,
            ipfsUrl,
            0, // collectionId
            tokenURI
          ]);
          showNotification("NFT Minted!");
          document.getElementById('quickMintForm').reset();
          document.getElementById('checkout-widget-container').innerHTML = '';
          loadStats();
        } catch (error) {
          showNotification('❌ Mint Error: ' + error.message);
        }
      }

      // === 3. Collections ===
      async function createCollection(name, description) {
        if (!contract) {
          showNotification('Please connect your wallet first');
          return;
        }
        await contract.call("createCollection", [name, description]);
        showNotification("Collection Created!");
      }

      // === 4. DeFi Locking ===
      async function lockTokens(tokenAddress, amount, duration, useYield) {
        if (!contract) {
          showNotification('Please connect your wallet first');
          return;
        }
        await contract.call("lockTokens", [tokenAddress, amount, duration, useYield]);
        showNotification("Tokens Locked!");
      }

      // === 5. Payments (CheckoutWidget) ===
      function showCheckoutWidget(name, description, onSuccess) {
        const widget = new thirdweb.CheckoutWidget({
          clientId: CLIENT_ID,
          chain: CHAIN,
          amount: "0.01",
          tokenAddress: "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913", // USDC on Base
          seller: TREASURY_ADDRESS,
          name,
          description,
          onPaymentSuccess: onSuccess,
          onError: (error) => showNotification("Payment failed: " + error.message),
        });
        widget.render(document.getElementById("checkout-widget-container"));
      }

      // === 6. Multichain Support ===
      async function switchChain(chain) {
        CHAIN = chain;
        sdk = new thirdweb.ThirdwebSDK(chain, { clientId: CLIENT_ID });
        contract = await sdk.getContract(CONTRACT_ADDRESS);
        showNotification("Switched to " + chain);
      }

      // === 7. Storage (IPFS Upload) ===
      async function uploadToIPFS(file) {
        return await sdk.storage.upload(file);
      }

      // === 8. UI Event Bindings ===
      document.getElementById("connectBtn").addEventListener("click", connectWallet);

      document.getElementById("payAndMintBtn").addEventListener("click", async () => {
        const name = document.getElementById("nftName").value;
        const description = document.getElementById("nftDescription").value;
        const file = document.getElementById("nftFile").files[0];
        showCheckoutWidget("Mint NFT: " + name, description, async () => {
          await mintNFT(name, description, "image", file);
        });
      });

      document.getElementById("quickMintForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = document.getElementById("nftName").value;
        const description = document.getElementById("nftDescription").value;
        const file = document.getElementById("nftFile").files[0];
        await mintNFT(name, description, "image", file);
      });

      document.getElementById("createCollectionForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = document.getElementById("collectionName").value;
        const description = document.getElementById("collectionDescription").value;
        await createCollection(name, description);
      });

      document.getElementById("lockForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const tokenAddress = document.getElementById("tokenAddress").value;
        const amount = document.getElementById("lockAmount").value;
        const duration = parseInt(document.getElementById("lockDuration").value) * 86400;
        const useYield = document.getElementById("useYield").checked;
        await lockTokens(tokenAddress, amount, duration, useYield);
      });

      // === 9. Tab Switching ===
      window.switchTab = function(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(tabName + '-tab').classList.add('active');
      };

      // === 10. Load Stats ===
      async function loadStats() {
        if (!contract) return;
        try {
          const totalSupply = await contract.call('totalSupply');
          document.getElementById('totalNFTs').textContent = totalSupply.toString();
        } catch (error) {
          console.error('Error loading stats:', error);
        }
      }

      // === 11. Show Notification ===
      function showNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => { notification.remove(); }, 3000);
      }
    });
  </script>
</body>
</html>
